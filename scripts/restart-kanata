#!/bin/bash
#
# Restart Kanata service manually
# Use this if Kanata stops working
#

set -euo pipefail

echo "üîÑ Restarting Kanata service..."

# Stop the service
echo "Stopping Kanata daemon..."
sudo launchctl bootout system/com.example.kanata 2>/dev/null || true

# Kill any remaining processes
echo "Cleaning up any remaining processes..."
sudo pkill -f "kanata.*config.kbd" 2>/dev/null || true

# Wait a moment
sleep 3

# Restart the service
echo "Starting Kanata daemon..."
sudo launchctl bootstrap system /Library/LaunchDaemons/com.example.kanata.plist

# Wait and check status
sleep 5
echo "Checking status..."
if sudo launchctl print system/com.example.kanata | grep -q "state = running"; then
    echo "‚úÖ Kanata is now running successfully!"
    ps aux | grep "[k]anata.*config.kbd" || echo "Process details not found"
else
    echo "‚ùå Kanata failed to start. Check logs:"
    echo "sudo tail /var/log/kanata-startup.log"
    echo "sudo tail /var/log/kanata.err"
fi
